variables:
    IMAGE: frontier-service
    VERSION: '1.11'
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"

# Make the gradle wrapper executable. This essentially downloads a copy of
# Gradle to build the project with.
# https://docs.gradle.org/current/userguide/gradle_wrapper.html
# It is expected that any modern gradle project has a wrapper
before_script:
  - chmod +x gradlew

include:
  - project : 'ci-tools/container-image-ci-templates'
    file : 'kaniko-image.gitlab-ci.yml'
    ref: master

stages:
 - package_application
 - push
 - build_rpm

package_cern_application:
  stage: package_application
  image: registry.cern.ch/docker.io/eclipse-temurin:17-alpine
  script:
   - ./gradlew clean build -x test
  allow_failure: false
  artifacts:
   paths:
   - ./build/dist/Frontier.war

# Can be used to test packaging helm chart, before merging to master for instance
#build_helm:
#  extends: .deploy_helm
#  stage: build
#  variables:
#    REGISTRY_CHART_PATH: registry.cern.ch/crest/charts


build_container_job:
  rules:
    - if: $CI_PIPELINE_SOURCE != 'merge_request_event'
  stage: push
  extends: .build_kaniko
  variables:
    REGISTRY_IMAGE_PATH : "registry.cern.ch/crest/$IMAGE:$VERSION"
    CONTEXT_DIR: ""
    PUSH_IMAGE: "true"
    DOCKER_FILE_NAME: "Dockerfile"

build_rpm_job:
  stage: build_rpm
  image: registry.cern.ch/docker.io/almalinux:9
  variables:
    RPM_TMP_DIR: "/tmp/rpms"  # Build in /tmp
    RPM_OUTPUT_DIR: "$CI_PROJECT_DIR/rpms/frontier-tomcat"  # Final output dir
  before_script:
      - dnf upgrade -y --refresh && dnf install -y rpm-build rpmdevtools findutils git wget rpm-sign && dnf clean all
      - cp ./package-rpm/get-rpms.sh /tmp/get-rpms.sh
      - chmod +x /tmp/get-rpms.sh
      - /tmp/get-rpms.sh
      - cp ./package-rpm/frontier-tomcat.spec /tmp/rpms/frontier-tomcat/SPECS/frontier-tomcat.spec
  script:
    - cd /tmp/rpms/frontier-tomcat
    - pushd ./scripts; ../../scripts/rpmbuild_.sh; popd
    - mkdir -p $RPM_OUTPUT_DIR
    - cp -rv $RPM_TMP_DIR/frontier-tomcat/{RPMS,SRPMS} $RPM_OUTPUT_DIR/
  allow_failure: false
  artifacts:
    paths:
      - rpms/frontier-tomcat/RPMS/  # Now these paths are relative to $CI_PROJECT_DIR
      - rpms/frontier-tomcat/SRPMS/
    expire_in: 1 week


